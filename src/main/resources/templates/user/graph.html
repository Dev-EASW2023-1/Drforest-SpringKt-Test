<html xmlns:th="http://www.thymeleaf.org">
    <head>
        <script src="https://cdn.jsdelivr.net/npm/chart.js@3.7.1/dist/chart.js"></script>
        <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.0.0"></script>
        <script src="https://cdn.jsdelivr.net/npm/moment@2.29.1/moment.min.js"></script>
        <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-moment@1.0.0/dist/chartjs-adapter-moment.min.js"></script>
        <title> DrForest - User Graph </title>
    </head>

    <body>
        <div style="height: 100%;width: 100%;">
            <div style="height: 20%;width: 100%;">
                <canvas id="line-chart1"></canvas>
            </div>
            <div style="height: 20%;width: 100%;">
                <canvas id="line-chart2"></canvas>
            </div>

            <div style="height: 20%;width: 100%;">
                <canvas id="line-chart3"></canvas>
            </div>

            <div style="height: 20%;width: 100%;">
                <canvas id="line-chart4"></canvas>
            </div>

            <div style="height: 20%;width: 100%;">
                <canvas id="line-chart5"></canvas>
            </div>
            <script lang="text/javascript" th:inline="javascript">
                "use strict";
                let startTimeCurrent = /*[[${start}]]*/ 'default';
                let endTimeCurrent = /*[[${end}]]*/ 'default';
                let data = /*[[${graph}]]*/ 'default';
                let chartColors = {
                    inaccurateBorder: 'rgb(186,81,0)',
                    nonFilledGraphColor: 'rgba(222, 60, 60, 0.4)',
                    accurateBorder: 'rgb(0, 80, 30)',
                    background: 'rgb(0, 162, 72)',
                    realTimeDataLine: 'rgba(0,72,255, 0.4)'
                };

                let timeArray = [];
                let colorArray = [];
                let dateGpsArray = [];
                let dateStepArray = [];
                let dateTrafficArray = [];
                let dateOnOffArray = [];
                let dateDozeArray = [];

                let minuteGpsArray = [];
                let minuteStepArray = [];
                let minuteTrafficArray = [];
                let minuteOnOffArray = [];
                let minuteDozeArray = [];

                data["list"].forEach(dto => {
                    timeArray.push(dto["time"])
                    minuteGpsArray.push({
                        x: moment(dto["time"]),
                        y: (dto["value"]["GPS"] ?? 0) / 1024
                    })

                    minuteStepArray.push({
                        x: moment(dto["time"]),
                        y: (dto["value"]["Step"] ?? 0)
                    })

                    minuteOnOffArray.push({
                        x: moment(dto["time"]),
                        y: (dto["value"]["OnOff"] ?? 0) / 60
                    })

                    minuteDozeArray.push({
                        x: moment(dto["time"]),
                        y: (dto["value"]["Idle"] ?? 0) / 60
                    })

                    minuteTrafficArray.push({
                        x: moment(dto["time"]),
                        y: (dto["value"]["Traffic"] ?? 0) / 1024 / 1024
                    })
                });

                makeChart(null, "line-chart1", "km  ", false, 1, false, colorArray, timeArray, dateGpsArray, "사회적 관계 수치", minuteGpsArray, "이동거리 (미터)");
                makeChart(null, "line-chart2", "걸음  ", true, 1, false, colorArray, timeArray, dateStepArray, "정신운동성 수치", minuteStepArray, "운동량 (걸음)");
                makeChart(null, "line-chart3", "MB ", false, 1, false, colorArray, timeArray, dateTrafficArray, "관심 / 흥미 수치", minuteTrafficArray, "스마트폰 데이터 사용량 (바이트)");
                makeFilledChart(null, "line-chart4", "분      ", true, colorArray, timeArray, dateOnOffArray, "하루간 정신건강결과 수치", minuteOnOffArray, "스마트폰 사용여부 (분)");
                makeFilledChart(null, "line-chart5", "분      ", true, colorArray, timeArray, dateDozeArray, "신체적운동 수치", minuteDozeArray, "수면시간 (분)");


                makeFullChart("line-chart")
                /**
                 * Display chart with one bar, and two line.
                 * @param chartElementId Chart ID on HTML.
                 * @param time Time array.
                 *          Schema: [
                 *              "MM-dd HH:mm:ss",
                 *              "MM-dd HH:mm:ss",
                 *              "MM-dd HH:mm:ss"...
                 *          ]
                 * @param charts Chart metadata.
                 *          Schema: [
                 *              {
                 *                  name: "Bar chart name",
                 *                  data: [
                 *                      {x: "MM-dd HH:mm:ss", y: 1},
                 *                      {x: "MM-dd HH:mm:ss", y: 2},
                 *                      {x: "MM-dd HH:mm:ss", y: 3}...
                 *                  ]
                 *              },
                 *              {
                 *                  name: "First line chart name",
                 *                  data: [
                 *                      {x: "MM-dd HH:mm:ss", y: 1},
                 *                      {x: "MM-dd HH:mm:ss", y: 2},
                 *                      {x: "MM-dd HH:mm:ss", y: 3}...
                 *                  ]
                 *              },
                 *              {
                 *                  name: "Second line chart name",
                 *                  data: [
                 *                      {x: "MM-dd HH:mm:ss", y: 1},
                 *                      {x: "MM-dd HH:mm:ss", y: 2},
                 *                      {x: "MM-dd HH:mm:ss", y: 3}...
                 *                  ]
                 *              }
                 *          ]
                 */
                function makeFullChart(chartElementId, time, charts) {
                    let ctx = document.getElementsByName(chartElementId);
                    let chart = new Chart(ctx, {
                        plugins: [ChartDataLabels],
                        data: {
                            labels: time,
                            datasets: [
                                {
                                    xAxisID: 'barChartX',
                                    yAxisID: 'barChartY',
                                    type: "bar",
                                    data: charts[0].data,
                                    label: charts[0].name,
                                    spanGaps: false,
                                    datalabels: {
                                        display: true
                                    }
                                },
                                {
                                    xAxisID: 'firstLineChartX',
                                    yAxisID: 'firstLineChartY',
                                    type: "line",
                                    data: charts[1].data,
                                    label: charts[1].name,
                                    spanGaps: false,
                                    datalabels: {
                                        display: false
                                    }
                                },
                                {
                                    xAxisID: 'secondLineChartX',
                                    yAxisID: 'secondLineChartY',
                                    type: "line",
                                    data: charts[2].data,
                                    label: charts[2].name,
                                    spanGaps: false,
                                    datalabels: {
                                        display: false
                                    }
                                },
                            ],
                            options: {
                                spanGaps: false,
                                maintainAspectRatio: false,
                                title: {
                                    display: true,
                                    text: '정신 건강 데이터 (0-5, 정상 상태 3)'
                                },
                                plugins: {
                                    legend: {
                                        reverse: true,
                                    },
                                    tooltip: {
                                        callbacks: {}
                                    },
                                },
                                axis: {
                                    x: {
                                        autoSkip: true,
                                        gridLines: {
                                            drawOnChartArea: false
                                        }
                                    },
                                },
                                scales: {
                                    barChartX: {
                                        type: 'timeseries',
                                        grid: {
                                            display: true,
                                            drawBorder: true,
                                            drawTicks: true,
                                            drawOnChartArea: true
                                        },
                                        time: {
                                            unit: 'day',
                                            displayFormats: {
                                                day: 'YYYY-MM-DD'
                                            },
                                            tooltipFormat: 'YYYY-MM-DD'
                                        },
                                        ticks: {
                                            callback: function (tick, index, array) {
                                                return (index % 15) ? "" : tick;
                                            }
                                        }
                                    },
                                    barChartY: {
                                        gridLines: {
                                            display: false,
                                        },
                                        suggestedMin: 0,
                                        suggestedMax: 5,
                                        ticks: {
                                            callback: function (value, index, ticks) {
                                                if (Math.floor(value) === value) {
                                                    return value;
                                                }
                                            }
                                        }
                                    },
                                    firstLineChartX: {
                                        type: 'timeseries',
                                        grid: {
                                            display: true,
                                            drawBorder: true,
                                            drawTicks: true,
                                            drawOnChartArea: true
                                        },
                                        time: {
                                            unit: 'day',
                                            displayFormats: {
                                                day: 'YYYY-MM-DD'
                                            },
                                            tooltipFormat: 'YYYY-MM-DD'
                                        },
                                        ticks: {
                                            callback: function (tick, index, array) {
                                                return (index % 15) ? "" : tick;
                                            }
                                        }
                                    },
                                    firstLineChartY: {
                                        gridLines: {
                                            display: false,
                                        },
                                        suggestedMin: 0,
                                        suggestedMax: 5,
                                        ticks: {
                                            callback: function (value, index, ticks) {
                                                if (Math.floor(value) === value) {
                                                    return value;
                                                }
                                            }
                                        }
                                    },
                                    secondLineChartX: {
                                        type: 'timeseries',
                                        grid: {
                                            display: true,
                                            drawBorder: true,
                                            drawTicks: true,
                                            drawOnChartArea: true
                                        },
                                        time: {
                                            unit: 'day',
                                            displayFormats: {
                                                day: 'YYYY-MM-DD'
                                            },
                                            tooltipFormat: 'YYYY-MM-DD'
                                        },
                                        ticks: {
                                            callback: function (tick, index, array) {
                                                return (index % 15) ? "" : tick;
                                            }
                                        }
                                    },
                                    secondLineChartY: {
                                        gridLines: {
                                            display: false,
                                        },
                                        suggestedMin: 0,
                                        suggestedMax: 5,
                                        ticks: {
                                            callback: function (value, index, ticks) {
                                                if (Math.floor(value) === value) {
                                                    return value;
                                                }
                                            }
                                        }
                                    },
                                },
                            }
                        }
                    })
                }
            </script>
        </div>
    </body>
</html>